<script src='jquery.min.js'></script>
<style type="text/css">
body, html {
    background: #eee;
    color: black;
    font-family: monospace;
    font-size: 11px;
    text-align: center;
}
h2 {
    font-size: 16px;
}
h3 {
    font-size: 13px;
}
#main {
    background: white;
    margin: auto;
    max-width: 520px;
    text-align: left;
    padding: 60px 40px;
}
#out {
    font-size: 10px;
    max-width: 100%;
    overflow: auto;
}
li {
    margin-bottom: 10px;
}
</style>
<script>
var sprites_image;

function generate() {
    if (!sprites_image) {
        alert("source image not valid");
        return;
    }
    var canvas=document.createElement('canvas');
    canvas.width=sprites_image.width;
    canvas.height=sprites_image.height;
    var ctx=canvas.getContext('2d');
    ctx.drawImage(sprites_image, 0, 0);
    var cdata = ctx.getImageData(0, 0, sprites_image.width, sprites_image.height);
    var data=cdata.data;

    var ostring="";
    var icount=0, isize=0;

    for (var y = 0; y < cdata.height; y++) {
        for (var s=0; s<64; s++) {
            ostring+="//SPRITE "+s+" y="+y+" programcounter="+isize+"\n";

            for (var lx=0; lx<6; lx++) {
                var x=lx+s*6;
                var idx = (x + y * cdata.width) * 4;
                var r = data[idx + 0];
                var g = data[idx + 1];
                var b = data[idx + 2];
                var a = data[idx + 3];
                var packed;
                if (a<128) {
                    packed=0xff;
                } else {
                    packed = (parseInt(r*(4/256))<<6) |
                             (parseInt(g*(4/256))<<4) |
                             (parseInt(b*(4/256))<<2);
                }
                ostring+="\tldi r16, "+packed+";\n\tout VIDEOPORT, r16;\n";
                isize+=4;
                icount+=2;
            }
            ostring+="\tjmp next_block;\n";
            isize+=4;
            icount++;
        }
    }
    var header="//font generated from SPRITE2CODE - by Sandro Maffiodo\n//code size="+isize+" instr count="+icount+"\n";
    $('#out').text(header+ostring);
}
function boot() {
    $('#f').on('change', function(ev) {
        var f = ev.target.files[0];
        var fr = new FileReader();
        fr.onload = function(ev2) {
            console.dir(ev2);
            sprites_image=new Image;
            sprites_image.src=ev2.target.result;
            $('#preview').attr('src', ev2.target.result);
            $('#previewbox').show();
        };
        fr.readAsDataURL(f);
    });
}
$(document).ready(boot);
</script>
<body>
    <div id='main'>
        <h2><b>2BITFONT</b></h2>
        by Sandro Maffiodo

        <h3>WHAT IS:</h3>
        SPRITES2CODE is a simple web tool to generate sprites code for AVR/Arduino. <br>
        <br>
        <center><!--<img width="100%" src='2bitfont.png'/>--></center>
        <br>
        TODO...
        
        <h3>RULES:</h3>
        <ul>
            <li>TODO...</li>
        </ul>
        
        <h3>INPUT:</h3>
        source image: <input id="f" type="file" /><br>
        <div id='previewbox' style='display: none'>
            <br>
            <img id='preview' style='max-width: 100%'/>
        </div>
        <br>
        
        <h3>OUTPUT:</h3>
        <button onclick='generate()'>GENERATE</button>
        <pre id='out'></pre>
    </div>
</body>

